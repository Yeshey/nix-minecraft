name: Monthly Fork Sync and Update

on:
  schedule:
    - cron: '0 0 1 * *' # Monthly on the 1st at midnight UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  sync-and-update:
    runs-on: ubuntu-latest
    # Extra safety: only run on your fork
    if: github.repository == 'Yeshey/nix-minecraft'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for rebase
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/Infinidoge/nix-minecraft.git || true
          git fetch upstream
          git fetch origin
      
      - name: Rebase development on upstream/master
        id: rebase_dev
        run: |
          git checkout development
          git rebase upstream/master
        continue-on-error: true
      
      - name: Check rebase status
        if: steps.rebase_dev.outcome == 'failure'
        run: |
          echo "::error::Rebase failed! Manual intervention required."
          echo "Conflict files:"
          git diff --name-only --diff-filter=U
          exit 1
      
      - name: Push rebased development
        run: |
          git push origin development --force-with-lease
      
      - name: Reset master to upstream/master
        run: |
          git checkout -B master upstream/master
          git branch --set-upstream-to=origin/master master
      
      - name: Squash merge development (excluding workflow)
        run: |
          # Squash merge without committing
          git merge --squash development
          
          # Reset the workflow file to exclude it from the merge
          git reset HEAD .github/workflows/monthly-fork-sync.yml || true
          git checkout HEAD .github/workflows/monthly-fork-sync.yml || true
          
          # Also exclude the upstream's update-locks.yml if it exists
          git reset HEAD .github/workflows/update-locks.yml || true
          git checkout HEAD .github/workflows/update-locks.yml || true
      
      - name: Commit squashed changes
        run: |
          git commit -m "Add LazyMC support"
      
      - name: Force push master
        run: |
          git push origin master --force-with-lease
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Workflow failed! Check the logs for details."
          echo "You may need to manually resolve conflicts and push."